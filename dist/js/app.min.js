/*! fend-neighborhood-map | Patrick Dorosz | ISC */

function hideListView(){var e=document.getElementsByClassName("list-view")[0];e.classList.contains("show-list-view")&&(e.classList.add("hide-list-view"),e.classList.remove("show-list-view"))}var model={area:{city:"Tokyo",country:"Japan",countrycode:"jp",locallang:"東京博物館",type:"Museum",position:{lat:35.6732619,lng:139.5703029}},locations:[{title:"Tokyo Metropolitan Art Museum",position:{lat:35.717181,lng:139.772818},type:"art",place_id:"ChIJb_o7HiiMGGARUKu8uO7fGIQ"},{title:"Tokyo Waterworks Historical Museum",position:{lat:35.7033346,lng:139.7604967},type:"history",place_id:"ChIJrVm8DD2MGGARX70ZvbreBlQ"},{title:"Mitsubishi Ichigokan Museum",position:{lat:35.67833169999999,lng:139.7632194},type:"art",place_id:"ChIJuyY-ZfqLGGAREYR9A10IXPQ"},{title:"Tokyo Toy Museum",position:{lat:35.68973,lng:139.718039},type:"general",place_id:"ChIJHeBCIOyMGGAR7BktETlUP_w"},{title:"Tokyo National Museum",position:{lat:35.7187026,lng:139.7763106},type:"history",place_id:"ChIJycHKF4OOGGARZlm_joH52qI"},{title:"Advertising Museum Tokyo",position:{lat:35.6649201,lng:139.7625548},type:"art",place_id:"ChIJ2VtGysKLGGAR2oS8_Y_o-pk"},{title:"National Museum of Western Art",position:{lat:35.71538690000001,lng:139.7758138},type:"art",place_id:"ChIJf8xB-pyOGGARizzhlNTcI7s"},{title:"Samurai Museum",position:{lat:35.6954844,lng:139.7035426},type:"history",place_id:"ChIJ__-PU9iMGGAR6KHVhaRiqH8"},{title:"National Museum of Nature and Science",position:{lat:35.716357,lng:139.7763826},type:"science",place_id:"ChIJ8Vuh65yOGGARyj4L5IBFiIk"},{title:"National Museum of Modern Art",position:{lat:35.6905432,lng:139.7546932},type:"art",place_id:"ChIJL0kSfg2MGGARKv5KX53ZZ2Y"}]},mapStyle=[{featureType:"all",elementType:"labels.text.fill",stylers:[{color:"#736c68"}]},{featureType:"landscape.man_made",elementType:"geometry.fill",stylers:[{color:"#e7e6e5"}]},{featureType:"landscape.natural",elementType:"all",stylers:[{visibility:"on"},{color:"#d4e4d3"}]},{featureType:"poi",elementType:"geometry.fill",stylers:[{visibility:"on"},{color:"#f5f5f5"}]},{featureType:"poi.park",elementType:"geometry.fill",stylers:[{color:"#d4e4d3"}]},{featureType:"road",elementType:"geometry.fill",stylers:[{color:"#f5f5f5"}]},{featureType:"road",elementType:"geometry.stroke",stylers:[{color:"#e7e6e5"},{gamma:"0.65"},{lightness:"0"}]},{featureType:"transit",elementType:"labels.text",stylers:[{visibility:"off"}]},{featureType:"water",elementType:"all",stylers:[{color:"#aad5df"}]}],classCallCheck=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},createClass=function(){function e(e,t){for(var o=0;o<t.length;o++){var a=t[o];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}return function(t,o,a){return o&&e(t.prototype,o),a&&e(t,a),t}}(),DisplayViewModel=function(){function e(){classCallCheck(this,e);var t=this;t.mapReady=ko.observable(!1),t.query=ko.observable(""),model.area.locallang?t.mainTitle=model.area.locallang+" - "+model.area.city+" "+model.area.type+" Map Guide":t.mainTitle=model.area.city+" "+model.area.type+" Map Guide",t.markersObservable=ko.observableArray([]),t.createMarkersObservable=ko.computed(function(){if(t.mapReady())return t.markersObservable(GoogleMapView.markers),t.sort(t.markersObservable),!0},t),t.clickLocationList=function(e){hideListView(),GoogleMapView.popInfoWindow(e)},t.clickArrow=function(e){if(t.markersObservable().length>1){var o=(t.markersObservable.indexOf(GoogleMapView.mainInfoWindow.marker)+e)%t.markersObservable().length;-1===o&&(o=t.markersObservable().length-1);var a=t.markersObservable()[o];GoogleMapView.popInfoWindow(a)}},t.clickPrevArrow=function(){t.clickArrow(-1)},t.clickNextArrow=function(){t.clickArrow(1)},t.filterMarkerList=function(e){if(e){t.markersObservable([]);var o=!0,a=!1,i=void 0;try{for(var n,r=GoogleMapView.markers[Symbol.iterator]();!(o=(n=r.next()).done);o=!0){var l=n.value;l.title.toUpperCase().indexOf(e.toUpperCase())>=0?(t.markersObservable.push(l),l.getMap()||GoogleMapView.setMarkerMap(l,!0),GoogleMapView.queryBoundsExtend(l.position)):GoogleMapView.setMarkerMap(l,!1)}}catch(e){a=!0,i=e}finally{try{!o&&r.return&&r.return()}finally{if(a)throw i}}var s=t.markersObservable().length;1===s?(GoogleMapView.mainInfoWindow.marker||GoogleMapView.popInfoWindow(t.markersObservable()[0]),GoogleMapView.queryBoundsFit(!1)):s>1&&(GoogleMapView.closeInfoWindow(),t.sort(t.markersObservable),GoogleMapView.queryBoundsFit(!0))}else{var c=!0,p=!1,u=void 0;try{for(var d,m=GoogleMapView.markers[Symbol.iterator]();!(c=(d=m.next()).done);c=!0){var y=d.value;y.getMap()||GoogleMapView.setMarkerMap(y,!0)}}catch(e){p=!0,u=e}finally{try{!c&&m.return&&m.return()}finally{if(p)throw u}}t.markersObservable(GoogleMapView.markers),t.sort(t.markersObservable),t.resetMap()}},t.getVisibleMarkers=function(){return t.markersObservable()},t.query.subscribe(t.filterMarkerList)}return createClass(e,[{key:"sort",value:function(e){e.sort(function(e,t){return e.title===t.title?0:e.title>t.title?1:-1})}},{key:"resetMap",value:function(){this.query(""),GoogleMapView.resetMap()}}]),e}(),GoogleMapView=function(){function e(){classCallCheck(this,e)}return createClass(e,null,[{key:"closeInfoWindow",value:function(){e.mainInfoWindow.close(),e.mainInfoWindow.marker=null}},{key:"errorLoadMap",value:function(){alert("Unable to load Google Map at this time. Check your connection or try again later")}},{key:"initMap",value:function(){var t=document.getElementsByClassName("map")[0];e.map=new google.maps.Map(t,{center:{lat:model.area.position.lat,lng:model.area.position.lng},zoom:12,styles:mapStyle}),t.addEventListener("click",hideListView),e.markers=[],e.originalBounds=new google.maps.LatLngBounds,(e.mainInfoWindow=new google.maps.InfoWindow({maxWidth:250})).addListener("closeclick",function(){e.mainInfoWindow.marker=null});var o=function(){hideListView(),e.popInfoWindow(this)},a=!0,i=!1,n=void 0;try{for(var r,l=model.locations[Symbol.iterator]();!(a=(r=l.next()).done);a=!0){var s=r.value,c=new google.maps.Marker({position:s.position,title:s.title,animation:google.maps.Animation.DROP,icon:"img/icons/"+s.type+".png",map:e.map});c.addListener("click",o),e.markers.push(c),e.originalBounds.extend(c.position)}}catch(e){i=!0,n=e}finally{try{!a&&l.return&&l.return()}finally{if(i)throw n}}e.resetMap(),DisplayViewModel.instance.mapReady(!0)}},{key:"onWindowResize",value:function(){if(DisplayViewModel.instance){var t=DisplayViewModel.instance.getVisibleMarkers();if(t.length>1)if(e.mainInfoWindow.marker)e.map.panTo(e.mainInfoWindow.marker.position),e.map.panBy(0,-280);else{e.resizeBounds=new google.maps.LatLngBounds;var o=!0,a=!1,i=void 0;try{for(var n,r=t[Symbol.iterator]();!(o=(n=r.next()).done);o=!0){var l=n.value;e.resizeBounds.extend(l.position)}}catch(e){a=!0,i=e}finally{try{!o&&r.return&&r.return()}finally{if(a)throw i}}e.map.fitBounds(e.resizeBounds),e.resizeBounds=null,e.map.getZoom()>18&&e.map.setZoom(18)}else 1===t.length&&(e.map.panTo(t[0].position),e.map.panBy(0,-280))}if(window.matchMedia("(min-width: 768px)").matches){document.getElementsByClassName("list-view")[0].classList.remove("show-list-view")}}},{key:"popInfoWindow",value:function(t){function o(){var e=document.getElementsByClassName("info-arrows")[0],t="css: { 'btn-off': markersObservable().length < 2 }";e&&(e.children[0].setAttribute("data-bind","click: clickPrevArrow, "+t),e.children[1].setAttribute("data-bind","click: clickNextArrow, "+t),ko.applyBindings(DisplayViewModel.instance,e))}if(e.toggleBounceMarker(t),e.mainInfoWindow.marker!==t){e.mainInfoWindow.marker=t,e.map.panTo(t.position),e.map.panBy(0,-280);var a='<div class="info-title"><strong>'+t.title+"</strong></div>";a+='<div class="sk-circle">';for(var i=1;i<=12;i++)a+='<div class="sk-circle'+i+' sk-child"></div>';a+="</div>",e.mainInfoWindow.setContent(a),e.mainInfoWindow.open(e.map,t),function(t){return fetch("https://cors-anywhere.herokuapp.com/https://api.yelp.com/v3/businesses/search?term="+t.title.replace(/\s+/g,"+")+"&latitude="+t.position.lat()+"&longitude="+t.position.lng(),{method:"GET",headers:{authorization:"Bearer "+e.YELP_TOKEN}}).catch(function(e){return window.alert("Unable to retrieve this locations's Yelp data due to a connection error. Please try again later."),Promise.reject(e)}).then(function(e){return e.ok?e:Promise.reject(new Error("api.yelp.com connection error"))}).then(function(e){return e.json()}).then(function(e){return e.businesses[0]})}(t).then(function(i){i?(a='<div class="info-title"><strong>'+t.title+"</strong></div>",a+='<img class="yelp-img" src='+i.image_url+" alt="+t.title+">",a+='<div class="yelp-container">'+function(e){var t=Math.floor(e),o=e-t==.5?"_half":"";return'<img class="yelp-rating" src="img/yelp_stars_reg/regular_'+t+o+'.png" srcset="img/yelp_stars_reg/regular_'+t+o+'@2x.png 2x">'}(i.rating),a+='<a target="_blank" href="'+i.url+'">',a+='<img class="yelp-logo" src="img/yelp_trademark_rgb_outline.png" srcset="img/yelp_trademark_rgb_outline_2x.png 2x" alt="Yelp Logo">',a+="</a>",a+='<a class="yelp-reviews" href="'+i.url+'" target="_blank">Based on <strong>'+i.review_count+"</strong> review"+(i.review_count>1?"s":"")+"</a>",a+="<p><address>"+function(e){return e[e.length-1]===model.area.country&&(e=e.slice(0,e.length-1)),e.join("<br>")}(i.location.display_address)+"</address></p>",a+='<p class="yelp-info">Currently <strong>'+(i.is_closed?"CLOSED":"OPEN")+"</strong><br>",a+="Phone: "+i.display_phone+"</p>",a+="</div>",a+='<div class="info-arrows">',a+='<a href="#" aria-role="button" class="btn info-arrows-prev" >&lt;</a>',a+='<a href="#" class="btn info-arrows-next" aria-role="button" >&gt;</a>',a+="</div>",e.mainInfoWindow.setContent(a),o()):(a='<div class="info-title"><strong>'+t.title+"</strong></div>",a+="<p>This location's information is not found in Yelp's business directory. Try a different location.</p>",a+='<div class="info-arrows">',a+='<a href="#" aria-role="button" class="btn info-arrows-prev" >&lt;</a>',a+='<a href="#" class="btn info-arrows-next" aria-role="button" >&gt;</a>',a+="</div>",e.mainInfoWindow.setContent(a),o())}).catch(function(o){a='<div class="title"><strong>'+t.title+"</strong></div>",a+="<p>Unable to retrieve this location's Yelp data due to a connection error. Please try again later.</p>",e.mainInfoWindow.setContent(a),console.log(o)})}}},{key:"queryBoundsExtend",value:function(t){e.queryBounds||(e.queryBounds=new google.maps.LatLngBounds),e.queryBounds.extend(t)}},{key:"queryBoundsFit",value:function(t){t?(e.map.fitBounds(e.queryBounds),e.queryBounds=null):e.queryBounds=null,e.map.getZoom()>18&&e.map.setZoom(18)}},{key:"resetMap",value:function(){e.map.fitBounds(e.originalBounds),e.mainInfoWindow.marker=null,e.mainInfoWindow.close()}},{key:"setMarkerMap",value:function(t,o){o?t.setMap(e.map):t.setMap(null)}},{key:"toggleBounceMarker",value:function(t){t.getAnimation()?t.setAnimation(null):(e.markers.forEach(function(e){e.setAnimation(null)}),t.setAnimation(google.maps.Animation.BOUNCE),setTimeout(function(){return t.setAnimation(null)},1500))}}]),e}();GoogleMapView.YELP_TOKEN="n9BZFWy_zC3jyQyNV9u0Tdc6IhfkwyV8b4JBg2NYD9AaQuHaUx6II9ukiEQp2Z03m7Cmycz29Lu2n4Gc5LPu1wDjVVCGyignkEoZn167yyq07sbPEN7gF5GzE20YWnYx",DisplayViewModel.instance=new DisplayViewModel,ko.applyBindings(DisplayViewModel.instance),window.onresize=GoogleMapView.onWindowResize;var sidebarButton=document.getElementsByClassName("header-hamburger")[0];sidebarButton.addEventListener("click",function(){var e=document.getElementsByClassName("list-view")[0];e.classList.contains("show-list-view")?(e.classList.add("hide-list-view"),e.classList.remove("show-list-view")):(e.classList.remove("hide-list-view"),e.classList.add("show-list-view"))});